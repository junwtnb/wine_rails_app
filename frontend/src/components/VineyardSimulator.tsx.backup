import React, { useReducer, useEffect, useCallback } from 'react';

// å€‹åˆ¥ãƒ—ãƒ­ãƒƒãƒˆã®å‹å®šç¾©
interface GrapePlot {
  id: number;
  variety: GrapeVariety | null;
  plantDate: number | null;
  growth: number; // 0-100
  health: number; // 0-100
  waterLevel: number; // 0-100
  fertilizer: number; // 0-100
  isPlanted: boolean;
  canHarvest: boolean;
}

// ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å‹å®šç¾©
interface GameState {
  phase: 'setup' | 'planting' | 'growing' | 'harvest' | 'winemaking' | 'completed';
  day: number;
  season: 'spring' | 'summer' | 'autumn' | 'winter';
  year: number;

  // ã¶ã©ã†ç•‘ã®çŠ¶æ…‹ - è¤‡æ•°ã®ãƒ—ãƒ­ãƒƒãƒˆã‚’ç®¡ç†
  vineyard: {
    plots: GrapePlot[];
    size: number; // ãƒ—ãƒ­ãƒƒãƒˆæ•°
  };

  // å¤©å€™ã‚·ã‚¹ãƒ†ãƒ 
  weather: {
    current: WeatherType;
    temperature: number; // æ‘‚æ°
    rainfall: number; // mm
    forecast: WeatherType[];
  };

  // è³‡æºç®¡ç†
  resources: {
    money: number;
    water: number;
    fertilizer: number;
    pesticide: number;
  };

  // åç©«
  harvest: {
    quantity: number; // kg
    quality: number; // 0-100
    sugarContent: number; // Brixå€¤
    acidity: number; // %
  };

  // ãƒ¯ã‚¤ãƒ³é†¸é€ 
  wine: {
    fermentationDays: number;
    agingMonths: number;
    finalQuality: number; // 0-100
    style: WineStyle | null;
    score: number; // 0-100
    name: string;
  };

  // ã‚²ãƒ¼ãƒ çµ±è¨ˆ
  stats: {
    totalHarvests: number;
    bestWineScore: number;
    totalMoney: number;
    experience: number;
  };

  // UIçŠ¶æ…‹
  ui: {
    selectedAction: ActionType | null;
    showWeatherDetail: boolean;
    notifications: Notification[];
    gameSpeed: 1 | 2 | 4; // æ™‚é–“åŠ é€Ÿ
  };
}

// å‹å®šç¾©
interface GrapeVariety {
  id: string;
  name: string;
  emoji: string;
  growthTime: number; // æ—¥æ•°
  waterNeeds: number; // 1-5
  temperatureRange: [number, number]; // æœ€é©æ¸©åº¦ç¯„å›²
  diseaseResistance: number; // 1-5
  wineTypes: WineStyle[];
  price: number; // è‹—ã®ä¾¡æ ¼
}

type WeatherType = 'sunny' | 'cloudy' | 'rainy' | 'stormy' | 'snowy' | 'hot' | 'cold';

type Disease = {
  id: string;
  name: string;
  severity: number; // 1-5
  effect: 'growth' | 'health' | 'quality';
};

type WineStyle = 'dry' | 'sweet' | 'sparkling' | 'fortified' | 'ice';

type ActionType = 'water' | 'fertilize' | 'spray' | 'prune' | 'harvest' | 'ferment' | 'age';

interface Notification {
  id: string;
  message: string;
  type: 'info' | 'warning' | 'success' | 'error';
  timestamp: Date;
}

// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‹
type GameAction =
  | { type: 'START_GAME' }
  | { type: 'PLANT_GRAPE'; variety: GrapeVariety }
  | { type: 'PLANT_GRAPE_IN_PLOT'; plotId: number; variety: GrapeVariety }
  | { type: 'HARVEST_PLOT'; plotId: number }
  | { type: 'WATER_PLOT'; plotId: number; amount: number }
  | { type: 'FERTILIZE_PLOT'; plotId: number; amount: number }
  | { type: 'ADVANCE_TIME' }
  | { type: 'WATER_PLANTS'; amount: number }
  | { type: 'APPLY_FERTILIZER'; amount: number }
  | { type: 'SPRAY_PESTICIDE' }
  | { type: 'PRUNE_VINES' }
  | { type: 'HARVEST_GRAPES' }
  | { type: 'START_FERMENTATION'; style: WineStyle }
  | { type: 'AGE_WINE'; months: number }
  | { type: 'COMPLETE_WINE'; name: string }
  | { type: 'BUY_RESOURCES'; resource: keyof GameState['resources']; amount: number }
  | { type: 'SET_GAME_SPEED'; speed: 1 | 2 | 4 }
  | { type: 'TOGGLE_WEATHER_DETAIL' }
  | { type: 'DISMISS_NOTIFICATION'; id: string }
  | { type: 'UPDATE_WEATHER' }
  | { type: 'RESET_GAME' };

// ã¶ã©ã†å“ç¨®ãƒ‡ãƒ¼ã‚¿
const grapeVarieties: GrapeVariety[] = [
  {
    id: 'chardonnay',
    name: 'ã‚·ãƒ£ãƒ«ãƒ‰ãƒ',
    emoji: 'ğŸ‡',
    growthTime: 120,
    waterNeeds: 3,
    temperatureRange: [15, 25],
    diseaseResistance: 2,
    wineTypes: ['dry', 'sparkling'],
    price: 1000
  },
  {
    id: 'pinot-noir',
    name: 'ãƒ”ãƒãƒ»ãƒãƒ¯ãƒ¼ãƒ«',
    emoji: 'ğŸŸ£',
    growthTime: 140,
    waterNeeds: 4,
    temperatureRange: [12, 22],
    diseaseResistance: 1,
    wineTypes: ['dry'],
    price: 1500
  },
  {
    id: 'cabernet',
    name: 'ã‚«ãƒ™ãƒ«ãƒãƒ»ã‚½ãƒ¼ãƒ´ã‚£ãƒ‹ãƒ¨ãƒ³',
    emoji: 'ğŸ”´',
    growthTime: 160,
    waterNeeds: 2,
    temperatureRange: [18, 28],
    diseaseResistance: 4,
    wineTypes: ['dry', 'fortified'],
    price: 1200
  },
  {
    id: 'riesling',
    name: 'ãƒªãƒ¼ã‚¹ãƒªãƒ³ã‚°',
    emoji: 'ğŸŸ¡',
    growthTime: 110,
    waterNeeds: 3,
    temperatureRange: [10, 20],
    diseaseResistance: 3,
    wineTypes: ['sweet', 'ice'],
    price: 800
  }
];

// åˆæœŸçŠ¶æ…‹
const initialState: GameState = {
  phase: 'setup',
  day: 1,
  season: 'spring',
  year: 1,
  vineyard: {
    plots: Array.from({ length: 12 }, (_, i) => ({
      id: i + 1,
      variety: null,
      plantDate: null,
      growth: 0,
      health: 100,
      waterLevel: 50,
      fertilizer: 50,
      isPlanted: false,
      canHarvest: false
    })),
    size: 12
  },
  weather: {
    current: 'sunny',
    temperature: 20,
    rainfall: 0,
    forecast: ['sunny', 'cloudy', 'sunny']
  },
  resources: {
    money: 5000,
    water: 100,
    fertilizer: 50,
    pesticide: 20
  },
  harvest: {
    quantity: 0,
    quality: 0,
    sugarContent: 0,
    acidity: 0
  },
  wine: {
    fermentationDays: 0,
    agingMonths: 0,
    finalQuality: 0,
    style: null,
    score: 0,
    name: ''
  },
  stats: {
    totalHarvests: 0,
    bestWineScore: 0,
    totalMoney: 5000,
    experience: 0
  },
  ui: {
    selectedAction: null,
    showWeatherDetail: false,
    notifications: [],
    gameSpeed: 1
  }
};

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
const getSeason = (day: number): 'spring' | 'summer' | 'autumn' | 'winter' => {
  const dayOfYear = day % 365;
  if (dayOfYear < 90) return 'spring';
  if (dayOfYear < 180) return 'summer';
  if (dayOfYear < 270) return 'autumn';
  return 'winter';
};

const getRandomWeather = (season: string): WeatherType => {
  const weatherBySeason: Record<string, WeatherType[]> = {
    spring: ['sunny', 'cloudy', 'rainy'],
    summer: ['sunny', 'hot', 'cloudy'],
    autumn: ['cloudy', 'rainy', 'sunny'],
    winter: ['cold', 'snowy', 'cloudy']
  };
  const options = weatherBySeason[season] || ['sunny'];
  return options[Math.floor(Math.random() * options.length)];
};

const addNotification = (
  notifications: Notification[],
  message: string,
  type: 'info' | 'warning' | 'success' | 'error' = 'info'
): Notification[] => {
  const newNotification: Notification = {
    id: Date.now().toString(),
    message,
    type,
    timestamp: new Date()
  };
  return [newNotification, ...notifications.slice(0, 4)]; // æœ€å¤§5ä»¶ã¾ã§
};

// ãƒ¡ã‚¤ãƒ³ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼
function gameReducer(state: GameState, action: GameAction): GameState {
  switch (action.type) {
    case 'START_GAME':
      return { ...initialState, phase: 'planting' };

    case 'PLANT_GRAPE':
      if (state.resources.money < action.variety.price) {
        return {
          ...state,
          ui: {
            ...state.ui,
            notifications: addNotification(
              state.ui.notifications,
              'è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼',
              'error'
            )
          }
        };
      }

      return {
        ...state,
        phase: 'growing',
        vineyard: {
          ...state.vineyard,
          variety: action.variety,
          plantDate: state.day,
          growth: 0,
          health: 100
        },
        resources: {
          ...state.resources,
          money: state.resources.money - action.variety.price
        },
        ui: {
          ...state.ui,
          notifications: addNotification(
            state.ui.notifications,
            `${action.variety.name}ã‚’æ¤ãˆã¾ã—ãŸï¼ğŸŒ±`,
            'success'
          )
        }
      };

    case 'ADVANCE_TIME':
      if (!state.vineyard.variety) return state;

      const newDay = state.day + 1;
      const newSeason = getSeason(newDay);
      const newWeather = getRandomWeather(newSeason);
      const daysSinceStart = newDay - (state.vineyard.plantDate || 0);

      // æˆé•·è¨ˆç®—
      let growthIncrease = 1;
      if (state.weather.current === 'sunny') growthIncrease += 0.5;
      if (state.weather.current === 'rainy') growthIncrease += 0.3;
      if (state.weather.current === 'stormy') growthIncrease -= 0.5;

      // æ°´åˆ†ãƒ¬ãƒ™ãƒ«ã®å¤‰åŒ–
      let waterChange = -2; // åŸºæœ¬æ¶ˆè²»
      if (state.weather.current === 'rainy') waterChange += 15;
      if (state.weather.current === 'hot') waterChange -= 5;

      const newGrowth = Math.min(100, state.vineyard.growth + growthIncrease);
      const newWaterLevel = Math.max(0, state.vineyard.waterLevel + waterChange);

      // å¥åº·çŠ¶æ…‹ã®è¨ˆç®—
      let healthChange = 0;
      if (newWaterLevel < 20) healthChange -= 2;
      if (newWaterLevel > 80) healthChange -= 1;
      if (state.vineyard.fertilizer < 30) healthChange -= 1;

      const newHealth = Math.max(0, Math.min(100, state.vineyard.health + healthChange));

      // åç©«å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      const canHarvest = newGrowth >= 90 && daysSinceStart >= (state.vineyard.variety?.growthTime || 120);
      let newPhase = state.phase;
      let notifications = state.ui.notifications;

      if (canHarvest && state.phase === 'growing') {
        newPhase = 'harvest';
        notifications = addNotification(
          notifications,
          'ğŸ‡ ã¶ã©ã†ãŒåç©«ã§ãã¾ã™ï¼',
          'success'
        );
      }

      return {
        ...state,
        day: newDay,
        season: newSeason,
        year: Math.floor((newDay - 1) / 365) + 1,
        phase: newPhase,
        vineyard: {
          ...state.vineyard,
          growth: newGrowth,
          health: newHealth,
          waterLevel: newWaterLevel,
          fertilizer: Math.max(0, state.vineyard.fertilizer - 0.5)
        },
        weather: {
          ...state.weather,
          current: newWeather,
          temperature: 15 + Math.random() * 20,
          rainfall: state.weather.current === 'rainy' ? Math.random() * 10 : 0
        },
        ui: {
          ...state.ui,
          notifications
        }
      };

    case 'WATER_PLANTS':
      if (state.resources.water < action.amount) {
        return {
          ...state,
          ui: {
            ...state.ui,
            notifications: addNotification(
              state.ui.notifications,
              'æ°´ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼',
              'error'
            )
          }
        };
      }

      return {
        ...state,
        vineyard: {
          ...state.vineyard,
          waterLevel: Math.min(100, state.vineyard.waterLevel + action.amount)
        },
        resources: {
          ...state.resources,
          water: state.resources.water - action.amount
        },
        ui: {
          ...state.ui,
          notifications: addNotification(
            state.ui.notifications,
            'ğŸ’§ æ°´ã‚„ã‚Šã‚’ã—ã¾ã—ãŸ',
            'info'
          )
        }
      };

    case 'APPLY_FERTILIZER':
      if (state.resources.fertilizer < action.amount) {
        return {
          ...state,
          ui: {
            ...state.ui,
            notifications: addNotification(
              state.ui.notifications,
              'è‚¥æ–™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼',
              'error'
            )
          }
        };
      }

      return {
        ...state,
        vineyard: {
          ...state.vineyard,
          fertilizer: Math.min(100, state.vineyard.fertilizer + action.amount * 2)
        },
        resources: {
          ...state.resources,
          fertilizer: state.resources.fertilizer - action.amount
        },
        ui: {
          ...state.ui,
          notifications: addNotification(
            state.ui.notifications,
            'ğŸŒ¿ è‚¥æ–™ã‚’ä¸ãˆã¾ã—ãŸ',
            'info'
          )
        }
      };

    case 'HARVEST_GRAPES':
      const variety = state.vineyard.variety;
      if (!variety) return state;

      const baseQuantity = 100; // kg
      const qualityMultiplier = state.vineyard.health / 100;
      const growthMultiplier = state.vineyard.growth / 100;

      const harvestQuantity = Math.floor(baseQuantity * qualityMultiplier * growthMultiplier);
      const harvestQuality = Math.floor((state.vineyard.health + state.vineyard.growth) / 2);

      return {
        ...state,
        phase: 'winemaking',
        harvest: {
          quantity: harvestQuantity,
          quality: harvestQuality,
          sugarContent: 20 + Math.random() * 10,
          acidity: 0.5 + Math.random() * 0.3
        },
        stats: {
          ...state.stats,
          totalHarvests: state.stats.totalHarvests + 1
        },
        ui: {
          ...state.ui,
          notifications: addNotification(
            state.ui.notifications,
            `ğŸ‡ ${harvestQuantity}kgã®ã¶ã©ã†ã‚’åç©«ã—ã¾ã—ãŸï¼`,
            'success'
          )
        }
      };

    case 'START_FERMENTATION':
      return {
        ...state,
        wine: {
          ...state.wine,
          style: action.style,
          fermentationDays: 0
        },
        ui: {
          ...state.ui,
          notifications: addNotification(
            state.ui.notifications,
            'ğŸ· ç™ºé…µã‚’é–‹å§‹ã—ã¾ã—ãŸ',
            'info'
          )
        }
      };

    case 'AGE_WINE':
      return {
        ...state,
        wine: {
          ...state.wine,
          agingMonths: action.months
        }
      };

    case 'COMPLETE_WINE':
      const baseScore = state.harvest.quality;
      const fermentationBonus = Math.min(10, state.wine.fermentationDays);
      const agingBonus = Math.min(15, state.wine.agingMonths * 2);
      const finalScore = Math.min(100, baseScore + fermentationBonus + agingBonus);

      const revenue = finalScore * 100; // ã‚¹ã‚³ã‚¢Ã—100å††

      return {
        ...state,
        phase: 'completed',
        wine: {
          ...state.wine,
          name: action.name,
          finalQuality: state.harvest.quality,
          score: finalScore
        },
        resources: {
          ...state.resources,
          money: state.resources.money + revenue
        },
        stats: {
          ...state.stats,
          bestWineScore: Math.max(state.stats.bestWineScore, finalScore),
          totalMoney: state.stats.totalMoney + revenue,
          experience: state.stats.experience + Math.floor(finalScore / 10)
        },
        ui: {
          ...state.ui,
          notifications: addNotification(
            state.ui.notifications,
            `ğŸ† ${action.name}ãŒå®Œæˆï¼ã‚¹ã‚³ã‚¢: ${finalScore}ç‚¹`,
            'success'
          )
        }
      };

    case 'BUY_RESOURCES':
      const costs = { money: 0, water: 2, fertilizer: 5, pesticide: 10 };
      const cost = costs[action.resource] * action.amount;

      if (state.resources.money < cost) {
        return {
          ...state,
          ui: {
            ...state.ui,
            notifications: addNotification(
              state.ui.notifications,
              'è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼',
              'error'
            )
          }
        };
      }

      return {
        ...state,
        resources: {
          ...state.resources,
          money: state.resources.money - cost,
          [action.resource]: state.resources[action.resource] + action.amount
        }
      };

    case 'SET_GAME_SPEED':
      return {
        ...state,
        ui: { ...state.ui, gameSpeed: action.speed }
      };

    case 'TOGGLE_WEATHER_DETAIL':
      return {
        ...state,
        ui: { ...state.ui, showWeatherDetail: !state.ui.showWeatherDetail }
      };

    case 'DISMISS_NOTIFICATION':
      return {
        ...state,
        ui: {
          ...state.ui,
          notifications: state.ui.notifications.filter(n => n.id !== action.id)
        }
      };

    case 'RESET_GAME':
      return initialState;

    default:
      return state;
  }
}

// ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
interface VineyardSimulatorProps {
  onClose: () => void;
}

const VineyardSimulator: React.FC<VineyardSimulatorProps> = ({ onClose }) => {
  const [state, dispatch] = useReducer(gameReducer, initialState);

  // useCallbackã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ¡ãƒ¢åŒ–
  const startGame = useCallback(() => {
    dispatch({ type: 'START_GAME' });
  }, []);

  const plantGrape = useCallback((variety: GrapeVariety) => {
    dispatch({ type: 'PLANT_GRAPE', variety });
  }, []);

  const advanceTime = useCallback(() => {
    dispatch({ type: 'ADVANCE_TIME' });
  }, []);

  const waterPlants = useCallback((amount: number) => {
    dispatch({ type: 'WATER_PLANTS', amount });
  }, []);

  const applyFertilizer = useCallback((amount: number) => {
    dispatch({ type: 'APPLY_FERTILIZER', amount });
  }, []);

  const harvestGrapes = useCallback(() => {
    dispatch({ type: 'HARVEST_GRAPES' });
  }, []);

  const startFermentation = useCallback((style: WineStyle) => {
    dispatch({ type: 'START_FERMENTATION', style });
  }, []);

  const completeWine = useCallback((name: string) => {
    dispatch({ type: 'COMPLETE_WINE', name });
  }, []);

  const resetGame = useCallback(() => {
    dispatch({ type: 'RESET_GAME' });
  }, []);

  // è‡ªå‹•æ™‚é–“é€²è¡Œ
  useEffect(() => {
    if (state.phase === 'growing' || state.phase === 'harvest') {
      const interval = setInterval(() => {
        advanceTime();
      }, 2000 / state.ui.gameSpeed); // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ã«å¿œã˜ã¦èª¿æ•´

      return () => clearInterval(interval);
    }
  }, [state.phase, state.ui.gameSpeed, advanceTime]);

  // å¤©å€™ã‚¢ã‚¤ã‚³ãƒ³
  const getWeatherEmoji = (weather: WeatherType) => {
    const emojis = {
      sunny: 'â˜€ï¸',
      cloudy: 'â˜ï¸',
      rainy: 'ğŸŒ§ï¸',
      stormy: 'â›ˆï¸',
      snowy: 'â„ï¸',
      hot: 'ğŸ”¥',
      cold: 'ğŸ§Š'
    };
    return emojis[weather];
  };

  return (
    <div className="vineyard-simulator-overlay">
      <div className="vineyard-simulator">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="game-header">
          <h2>ğŸ‡ ã¶ã©ã†ç•‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
          <div className="game-info">
            <span>å¹´: {state.year}</span>
            <span>æ—¥: {state.day}</span>
            <span>{state.season}</span>
            <span>{getWeatherEmoji(state.weather.current)}</span>
          </div>
          <button onClick={onClose} className="close-btn">âœ•</button>
        </div>

        {/* é€šçŸ¥ã‚¨ãƒªã‚¢ */}
        {state.ui.notifications.length > 0 && (
          <div className="notifications">
            {state.ui.notifications.map(notification => (
              <div
                key={notification.id}
                className={`notification ${notification.type}`}
                onClick={() => dispatch({ type: 'DISMISS_NOTIFICATION', id: notification.id })}
              >
                {notification.message}
              </div>
            ))}
          </div>
        )}

        {/* ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
        <div className="game-content">
          {/* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚§ãƒ¼ã‚º */}
          {state.phase === 'setup' && (
            <div className="setup-phase">
              <h3>ğŸ® ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</h3>
              <p>ã¶ã©ã†ã‚’è‚²ã¦ã¦ãƒ¯ã‚¤ãƒ³ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</p>
              <button onClick={startGame} className="start-btn">
                ã‚²ãƒ¼ãƒ é–‹å§‹
              </button>
            </div>
          )}

          {/* æ¤ãˆä»˜ã‘ãƒ•ã‚§ãƒ¼ã‚º */}
          {state.phase === 'planting' && (
            <div className="planting-phase">
              <h3>ğŸŒ± ã¶ã©ã†ã®å“ç¨®ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
              <div className="grape-varieties">
                {grapeVarieties.map(variety => (
                  <div key={variety.id} className="variety-card">
                    <div className="variety-header">
                      <span className="variety-emoji">{variety.emoji}</span>
                      <h4>{variety.name}</h4>
                    </div>
                    <div className="variety-stats">
                      <p>æˆé•·æœŸé–“: {variety.growthTime}æ—¥</p>
                      <p>æ°´åˆ†éœ€è¦: {'ğŸ’§'.repeat(variety.waterNeeds)}</p>
                      <p>ç—…æ°—è€æ€§: {'ğŸ›¡ï¸'.repeat(variety.diseaseResistance)}</p>
                      <p>ä¾¡æ ¼: Â¥{variety.price.toLocaleString()}</p>
                    </div>
                    <button
                      onClick={() => plantGrape(variety)}
                      disabled={state.resources.money < variety.price}
                      className="plant-btn"
                    >
                      æ¤ãˆã‚‹
                    </button>
                  </div>
                ))}
              </div>

              {/* ãƒ–ãƒ‰ã‚¦ç•‘ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º */}
              <div className="vineyard-grid-section">
                <h4>ğŸ‡ ã¶ã©ã†ç•‘ - ç©ºã„ã¦ã„ã‚‹ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¤ãˆã¦ãã ã•ã„</h4>
                <div className="grapes-grid">
                  {state.vineyard.plots.map(plot => (
                    <div
                      key={plot.id}
                      className={`grape-plot ${plot.isPlanted ? 'planted' : 'empty'} ${plot.canHarvest ? 'ready' : ''}`}
                      onClick={() => {
                        if (!plot.isPlanted) {
                          // TODO: ãƒ—ãƒ­ãƒƒãƒˆã«æ¤ãˆã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…
                          console.log(`Plot ${plot.id} clicked`);
                        }
                      }}
                      title={
                        plot.isPlanted
                          ? `${plot.variety?.name} - æˆé•·åº¦: ${plot.growth}%`
                          : 'ç©ºãåœ° - ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¤ãˆã‚‹'
                      }
                    >
                      {plot.isPlanted ? (
                        plot.canHarvest ? 'ğŸ‡' : plot.variety?.emoji || 'ğŸŒ±'
                      ) : 'â¬œ'}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* æˆé•·ãƒ•ã‚§ãƒ¼ã‚º */}
          {state.phase === 'growing' && (
            <div className="growing-phase">
              <div className="vineyard-status">
                <h3>ğŸ‡ {state.vineyard.variety?.name}ã®æˆé•·çŠ¶æ³</h3>
                <div className="status-bars">
                  <div className="status-item">
                    <label>æˆé•·åº¦: {state.vineyard.growth.toFixed(1)}%</label>
                    <div className="progress-bar">
                      <div
                        className="progress-fill growth"
                        style={{ width: `${state.vineyard.growth}%` }}
                      />
                    </div>
                  </div>
                  <div className="status-item">
                    <label>å¥åº·åº¦: {state.vineyard.health.toFixed(1)}%</label>
                    <div className="progress-bar">
                      <div
                        className="progress-fill health"
                        style={{ width: `${state.vineyard.health}%` }}
                      />
                    </div>
                  </div>
                  <div className="status-item">
                    <label>æ°´åˆ†ãƒ¬ãƒ™ãƒ«: {state.vineyard.waterLevel.toFixed(1)}%</label>
                    <div className="progress-bar">
                      <div
                        className="progress-fill water"
                        style={{ width: `${state.vineyard.waterLevel}%` }}
                      />
                    </div>
                  </div>
                  <div className="status-item">
                    <label>è‚¥æ–™ãƒ¬ãƒ™ãƒ«: {state.vineyard.fertilizer.toFixed(1)}%</label>
                    <div className="progress-bar">
                      <div
                        className="progress-fill fertilizer"
                        style={{ width: `${state.vineyard.fertilizer}%` }}
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div className="actions">
                <h4>ğŸ”§ ã‚±ã‚¢</h4>
                <div className="action-buttons">
                  <button
                    onClick={() => waterPlants(20)}
                    disabled={state.resources.water < 20}
                    className="action-btn water"
                  >
                    ğŸ’§ æ°´ã‚„ã‚Š (20)
                  </button>
                  <button
                    onClick={() => applyFertilizer(10)}
                    disabled={state.resources.fertilizer < 10}
                    className="action-btn fertilizer"
                  >
                    ğŸŒ¿ è‚¥æ–™ (10)
                  </button>
                  <button
                    onClick={advanceTime}
                    className="action-btn time"
                  >
                    â­ï¸ æ™‚é–“ã‚’é€²ã‚ã‚‹
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* åç©«ãƒ•ã‚§ãƒ¼ã‚º */}
          {state.phase === 'harvest' && (
            <div className="harvest-phase">
              <h3>ğŸ‡ åç©«ã®æ™‚æœŸã§ã™ï¼</h3>
              <p>ã¶ã©ã†ãŒååˆ†ã«æˆé•·ã—ã¾ã—ãŸã€‚åç©«ã—ã¦ãƒ¯ã‚¤ãƒ³ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚</p>
              <button onClick={harvestGrapes} className="harvest-btn">
                ğŸ‡ åç©«ã™ã‚‹
              </button>
            </div>
          )}

          {/* ãƒ¯ã‚¤ãƒ³ä½œã‚Šãƒ•ã‚§ãƒ¼ã‚º */}
          {state.phase === 'winemaking' && (
            <div className="winemaking-phase">
              <div className="harvest-results">
                <h3>ğŸ“Š åç©«çµæœ</h3>
                <div className="harvest-stats">
                  <div className="stat">
                    <strong>åç©«é‡:</strong> {state.harvest.quantity}kg
                  </div>
                  <div className="stat">
                    <strong>å“è³ª:</strong> {state.harvest.quality.toFixed(1)}%
                  </div>
                  <div className="stat">
                    <strong>ç³–åº¦:</strong> {state.harvest.sugarContent.toFixed(1)}Â°Brix
                  </div>
                  <div className="stat">
                    <strong>é…¸åº¦:</strong> {state.harvest.acidity.toFixed(2)}%
                  </div>
                </div>
              </div>

              <div className="wine-style-selection">
                <h4>ğŸ· ãƒ¯ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ</h4>
                <div className="wine-styles">
                  {state.vineyard.variety?.wineTypes.map(style => (
                    <button
                      key={style}
                      onClick={() => startFermentation(style)}
                      className="wine-style-btn"
                    >
                      {style === 'dry' ? 'ğŸ· è¾›å£' :
                       style === 'sweet' ? 'ğŸ¯ ç”˜å£' :
                       style === 'sparkling' ? 'ğŸ¥‚ ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒªãƒ³ã‚°' :
                       style === 'fortified' ? 'ğŸ›¡ï¸ é…’ç²¾å¼·åŒ–' :
                       'ğŸ§Š ã‚¢ã‚¤ã‚¹ãƒ¯ã‚¤ãƒ³'}
                    </button>
                  ))}
                </div>
              </div>

              {state.wine.style && (
                <div className="wine-completion">
                  <h4>âœ¨ ãƒ¯ã‚¤ãƒ³å®Œæˆ</h4>
                  <input
                    type="text"
                    placeholder="ãƒ¯ã‚¤ãƒ³ã®åå‰ã‚’å…¥åŠ›..."
                    className="wine-name-input"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        const target = e.target as HTMLInputElement;
                        if (target.value.trim()) {
                          completeWine(target.value.trim());
                        }
                      }
                    }}
                  />
                  <button
                    onClick={() => {
                      const input = document.querySelector('.wine-name-input') as HTMLInputElement;
                      if (input?.value.trim()) {
                        completeWine(input.value.trim());
                      }
                    }}
                    className="complete-wine-btn"
                  >
                    ğŸ· ãƒ¯ã‚¤ãƒ³å®Œæˆ
                  </button>
                </div>
              )}
            </div>
          )}

          {/* å®Œæˆãƒ•ã‚§ãƒ¼ã‚º */}
          {state.phase === 'completed' && (
            <div className="completed-phase">
              <div className="wine-results">
                <h3>ğŸ‰ ãƒ¯ã‚¤ãƒ³å®Œæˆï¼</h3>
                <div className="wine-card">
                  <h4>ğŸ· {state.wine.name}</h4>
                  <div className="wine-score">
                    <strong>æœ€çµ‚ã‚¹ã‚³ã‚¢: {state.wine.score}ç‚¹</strong>
                  </div>
                  <div className="wine-details">
                    <p>å“ç¨®: {state.vineyard.variety?.name}</p>
                    <p>ã‚¹ã‚¿ã‚¤ãƒ«: {state.wine.style}</p>
                    <p>å“è³ª: {state.wine.finalQuality.toFixed(1)}%</p>
                  </div>
                </div>

                <div className="game-stats">
                  <h4>ğŸ“Š çµ±è¨ˆ</h4>
                  <div className="stats-grid">
                    <div className="stat">ç·åç©«: {state.stats.totalHarvests}å›</div>
                    <div className="stat">æœ€é«˜ã‚¹ã‚³ã‚¢: {state.stats.bestWineScore}ç‚¹</div>
                    <div className="stat">ç·åç›Š: Â¥{state.stats.totalMoney.toLocaleString()}</div>
                    <div className="stat">çµŒé¨“å€¤: {state.stats.experience}</div>
                  </div>
                </div>

                <button onClick={resetGame} className="new-game-btn">
                  ğŸ”„ æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹
                </button>
              </div>
            </div>
          )}
        </div>

        {/* ãƒªã‚½ãƒ¼ã‚¹è¡¨ç¤º */}
        <div className="resource-panel">
          <div className="resource-item">
            <span>ğŸ’°</span>
            <span>Â¥{state.resources.money.toLocaleString()}</span>
          </div>
          <div className="resource-item">
            <span>ğŸ’§</span>
            <span>{state.resources.water}</span>
          </div>
          <div className="resource-item">
            <span>ğŸŒ¿</span>
            <span>{state.resources.fertilizer}</span>
          </div>
          <div className="resource-item">
            <span>ğŸ›¡ï¸</span>
            <span>{state.resources.pesticide}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VineyardSimulator;